#!/usr/bin/env bash
set -euo pipefail

# RedVPN CLI - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ VPN —Å–µ—Ä–≤–∏—Å–æ–º
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: redvpn [start|stop|status|restart]

SERVICE_NAME="redvpn.service"

show_usage() {
    echo "RedVPN CLI - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ VPN —Å–µ—Ä–≤–∏—Å–æ–º"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "  redvpn start   - –í–∫–ª—é—á–∏—Ç—å VPN"
    echo "  redvpn stop    - –í—ã–∫–ª—é—á–∏—Ç—å VPN"
    echo "  redvpn status  - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å VPN"
    echo "  redvpn restart - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å VPN"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  redvpn start"
    echo "  redvpn stop"
    echo "  redvpn status"
}

case "${1:-}" in
    start)
        echo "–í–∫–ª—é—á–µ–Ω–∏–µ RedVPN..."
        systemctl start "$SERVICE_NAME"
        sleep 2
        if systemctl is-active --quiet "$SERVICE_NAME"; then
            echo "‚úÖ RedVPN –≤–∫–ª—é—á–µ–Ω"
            echo "IP —á–µ—Ä–µ–∑ VPN: $(curl -s ifconfig.me 2>/dev/null || echo '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω')"
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è RedVPN"
            exit 1
        fi
        ;;
    stop)
        echo "–í—ã–∫–ª—é—á–µ–Ω–∏–µ RedVPN..."
        systemctl stop "$SERVICE_NAME"
        sleep 1
        if ! systemctl is-active --quiet "$SERVICE_NAME"; then
            echo "‚úÖ RedVPN –≤—ã–∫–ª—é—á–µ–Ω"
            echo "IP –±–µ–∑ VPN: $(curl -s ifconfig.me 2>/dev/null || echo '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω')"
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏—è RedVPN"
            exit 1
        fi
        ;;
    status)
        if systemctl is-active --quiet "$SERVICE_NAME"; then
            echo "üü¢ RedVPN –∞–∫—Ç–∏–≤–µ–Ω"
            echo "IP: $(curl -s ifconfig.me 2>/dev/null || echo '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω')"
        else
            echo "üî¥ RedVPN –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω"
        fi
        ;;
    restart)
        echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ RedVPN..."
        systemctl restart "$SERVICE_NAME"
        sleep 3
        if systemctl is-active --quiet "$SERVICE_NAME"; then
            echo "‚úÖ RedVPN –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
            echo "IP: $(curl -s ifconfig.me 2>/dev/null || echo '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω')"
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ RedVPN"
            exit 1
        fi
        ;;
    help|--help|-h)
        show_usage
        ;;
    "")
        echo "–û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞"
        echo ""
        show_usage
        exit 1
        ;;
    *)
        echo "–û—à–∏–±–∫–∞: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ '$1'"
        echo ""
        show_usage
        exit 1
        ;;
esac
